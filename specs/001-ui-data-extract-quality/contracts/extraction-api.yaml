openapi: 3.0.3
info:
  title: Invoice Extraction and Quality API
  description: |
    Enhanced API endpoints for invoice extraction with per-field confidence tracking
    and quality metrics aggregation for dashboard analytics.
  version: 2.0.0
  contact:
    name: AI E-Invoicing Team

servers:
  - url: http://localhost:${API_PORT:-8000}/api/v1
    description: Local development server
  - url: https://api.einvoicing.example.com/api/v1
    description: Production server

tags:
  - name: extraction
    description: Invoice data extraction operations
  - name: quality
    description: Quality metrics and analytics

paths:
  /invoices/{invoice_id}/extracted-data:
    get:
      summary: Get extracted invoice data with per-field confidence scores
      description: Returns structured extracted data including per-field confidence scores for all critical fields
      operationId: getExtractedData
      tags:
        - extraction
      parameters:
        - name: invoice_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      
      responses:
        '200':
          description: Extracted data with confidence scores
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExtractedDataResponse'
              example:
                status: success
                timestamp: "2026-01-07T10:30:00Z"
                data:
                  invoice_id: "550e8400-e29b-41d4-a716-446655440000"
                  vendor_name: "ACME Corporation"
                  vendor_name_confidence: 0.95
                  invoice_number: "INV-2024-001"
                  invoice_number_confidence: 0.92
                  invoice_date: "2024-01-15"
                  invoice_date_confidence: 0.88
                  total_amount: 1100.00
                  total_amount_confidence: 0.96
                  subtotal: 1000.00
                  subtotal_confidence: 0.94
                  tax_amount: 100.00
                  tax_amount_confidence: 0.93
                  currency: "USD"
                  currency_confidence: 0.98
                  extraction_confidence: 0.94
                  extracted_at: "2026-01-07T10:15:00Z"
        
        '404':
          description: Invoice or extracted data not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    
    patch:
      summary: Update extracted invoice data (manual corrections)
      description: |
        Update one or more extracted fields with manual corrections.
        Automatically recalculates validation results after update.
      operationId: updateExtractedData
      tags:
        - extraction
      parameters:
        - name: invoice_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExtractedDataUpdate'
            examples:
              vendorCorrection:
                summary: Correct vendor name
                value:
                  vendor_name: "ACME Corporation Inc."
                  correction_note: "Corrected from abbreviated name"
              multipleFields:
                summary: Correct multiple fields
                value:
                  vendor_name: "Tech Solutions LLC"
                  invoice_number: "TS-2024-5678"
                  total_amount: 2750.00
                  correction_note: "Manual review - OCR misread several fields"
      
      responses:
        '200':
          description: Extracted data updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExtractedDataResponse'
        
        '400':
          description: Invalid update data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        
        '404':
          description: Invoice not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /quality/metrics:
    get:
      summary: Get aggregated quality metrics
      description: |
        Returns aggregated quality metrics for the dashboard including:
        - Overall extraction accuracy by file format
        - Average confidence scores per field
        - Missing field statistics
        - Validation failure breakdown
      operationId: getQualityMetrics
      tags:
        - quality
      parameters:
        - name: date_from
          in: query
          required: false
          description: Filter invoices from this date (ISO 8601)
          schema:
            type: string
            format: date
          example: "2024-01-01"
        
        - name: date_to
          in: query
          required: false
          description: Filter invoices until this date (ISO 8601)
          schema:
            type: string
            format: date
          example: "2024-12-31"
        
        - name: file_type
          in: query
          required: false
          description: Filter by file type
          schema:
            type: string
            enum: [pdf, csv, xlsx, jpg, png, all]
            default: all
        
        - name: group_by
          in: query
          required: false
          description: Grouping dimension for metrics
          schema:
            type: string
            enum: [file_type, date, category, group]
            default: file_type
      
      responses:
        '200':
          description: Quality metrics successfully retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QualityMetricsResponse'
              example:
                status: success
                timestamp: "2026-01-07T10:30:00Z"
                data:
                  summary:
                    total_invoices: 1523
                    completed_invoices: 1487
                    failed_invoices: 36
                    overall_accuracy: 0.87
                    stp_rate: 0.72
                  by_format:
                    - file_type: "xlsx"
                      total: 523
                      critical_fields_complete_pct: 0.95
                      avg_vendor_confidence: 0.96
                      avg_invoice_number_confidence: 0.94
                      avg_total_amount_confidence: 0.97
                    - file_type: "pdf"
                      total: 687
                      critical_fields_complete_pct: 0.85
                      avg_vendor_confidence: 0.82
                      avg_invoice_number_confidence: 0.79
                      avg_total_amount_confidence: 0.88
                    - file_type: "jpg"
                      total: 277
                      critical_fields_complete_pct: 0.76
                      avg_vendor_confidence: 0.71
                      avg_invoice_number_confidence: 0.68
                      avg_total_amount_confidence: 0.79
                  missing_fields:
                    vendor_name_missing: 124
                    invoice_number_missing: 89
                    total_amount_missing: 47
                  low_confidence_invoices:
                    count: 156
                    percentage: 0.10
                  validation_failures:
                    total: 213
                    by_rule:
                      - rule_name: "Math Validation"
                        count: 98
                      - rule_name: "Tax Rate Validation"
                        count: 67
                      - rule_name: "Date Format"
                        count: 48
                  date_range:
                    from: "2024-01-01"
                    to: "2024-12-31"

  /quality/trends:
    get:
      summary: Get quality metrics trends over time
      description: Returns time-series data for quality metrics to display trend charts
      operationId: getQualityTrends
      tags:
        - quality
      parameters:
        - name: date_from
          in: query
          required: true
          description: Start date for trend data
          schema:
            type: string
            format: date
        
        - name: date_to
          in: query
          required: true
          description: End date for trend data
          schema:
            type: string
            format: date
        
        - name: granularity
          in: query
          required: false
          description: Time granularity for data points
          schema:
            type: string
            enum: [day, week, month]
            default: day
        
        - name: metric
          in: query
          required: false
          description: Specific metric to retrieve (defaults to all)
          schema:
            type: string
            enum: [accuracy, confidence, stp_rate, all]
            default: all
      
      responses:
        '200':
          description: Trend data successfully retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TrendsResponse'
              example:
                status: success
                timestamp: "2026-01-07T10:30:00Z"
                data:
                  date_range:
                    from: "2024-01-01"
                    to: "2024-12-31"
                  granularity: "month"
                  series:
                    - metric: "overall_accuracy"
                      label: "Overall Extraction Accuracy"
                      data_points:
                        - date: "2024-01"
                          value: 0.78
                          invoice_count: 95
                        - date: "2024-02"
                          value: 0.82
                          invoice_count: 112
                        - date: "2024-03"
                          value: 0.87
                          invoice_count: 128
                    - metric: "stp_rate"
                      label: "Straight-Through Processing Rate"
                      data_points:
                        - date: "2024-01"
                          value: 0.58
                          invoice_count: 95
                        - date: "2024-02"
                          value: 0.65
                          invoice_count: 112
                        - date: "2024-03"
                          value: 0.72
                          invoice_count: 128

  /invoices/batch/process:
    post:
      summary: Process multiple invoices in parallel
      description: |
        Submit a batch of invoices for parallel processing with configurable concurrency.
        Returns a batch ID for tracking progress.
      operationId: processBatchInvoices
      tags:
        - extraction
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BatchProcessRequest'
            example:
              invoice_ids:
                - "550e8400-e29b-41d4-a716-446655440000"
                - "550e8400-e29b-41d4-a716-446655440001"
                - "550e8400-e29b-41d4-a716-446655440002"
              max_concurrency: 10
              force_reprocess: false
              processing_options:
                format_specific:
                  excel_column_mapping_enabled: true
                  pdf_text_detection_enabled: true
                  image_preprocessing_enabled: true
      
      responses:
        '202':
          description: Batch processing initiated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchProcessResponse'
              example:
                status: success
                timestamp: "2026-01-07T10:30:00Z"
                data:
                  batch_id: "batch-2026-01-07-001"
                  invoice_count: 3
                  estimated_completion_seconds: 45
                  status: "queued"
                  progress_url: "/api/v1/invoices/batch/batch-2026-01-07-001/progress"
        
        '400':
          description: Invalid batch request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /invoices/batch/{batch_id}/progress:
    get:
      summary: Get batch processing progress
      description: Returns current progress and status of a batch processing job
      operationId: getBatchProgress
      tags:
        - extraction
      parameters:
        - name: batch_id
          in: path
          required: true
          schema:
            type: string
      
      responses:
        '200':
          description: Batch progress retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchProgressResponse'
              example:
                status: success
                timestamp: "2026-01-07T10:31:00Z"
                data:
                  batch_id: "batch-2026-01-07-001"
                  status: "processing"
                  total_invoices: 20
                  completed: 12
                  failed: 1
                  in_progress: 7
                  progress_percentage: 60
                  started_at: "2026-01-07T10:30:00Z"
                  estimated_completion_at: "2026-01-07T10:32:30Z"

components:
  schemas:
    ExtractedDataResponse:
      type: object
      required:
        - status
        - timestamp
        - data
      properties:
        status:
          type: string
          enum: [success]
        timestamp:
          type: string
          format: date-time
        data:
          $ref: '#/components/schemas/ExtractedData'
    
    ExtractedData:
      type: object
      properties:
        invoice_id:
          type: string
          format: uuid
        vendor_name:
          type: string
          nullable: true
        vendor_name_confidence:
          type: number
          format: float
          minimum: 0.0
          maximum: 1.0
          nullable: true
        invoice_number:
          type: string
          nullable: true
        invoice_number_confidence:
          type: number
          format: float
          minimum: 0.0
          maximum: 1.0
          nullable: true
        invoice_date:
          type: string
          format: date
          nullable: true
        invoice_date_confidence:
          type: number
          format: float
          minimum: 0.0
          maximum: 1.0
          nullable: true
        total_amount:
          type: number
          format: decimal
          nullable: true
        total_amount_confidence:
          type: number
          format: float
          minimum: 0.0
          maximum: 1.0
          nullable: true
        subtotal:
          type: number
          format: decimal
          nullable: true
        subtotal_confidence:
          type: number
          format: float
          minimum: 0.0
          maximum: 1.0
          nullable: true
        tax_amount:
          type: number
          format: decimal
          nullable: true
        tax_amount_confidence:
          type: number
          format: float
          minimum: 0.0
          maximum: 1.0
          nullable: true
        currency:
          type: string
          nullable: true
        currency_confidence:
          type: number
          format: float
          minimum: 0.0
          maximum: 1.0
          nullable: true
        extraction_confidence:
          type: number
          format: float
          minimum: 0.0
          maximum: 1.0
          description: Overall document extraction confidence
        extracted_at:
          type: string
          format: date-time
    
    ExtractedDataUpdate:
      type: object
      properties:
        vendor_name:
          type: string
        invoice_number:
          type: string
        invoice_date:
          type: string
          format: date
        total_amount:
          type: number
          format: decimal
        subtotal:
          type: number
          format: decimal
        tax_amount:
          type: number
          format: decimal
        currency:
          type: string
          maxLength: 3
        correction_note:
          type: string
          description: Optional note explaining the manual correction
    
    QualityMetricsResponse:
      type: object
      required:
        - status
        - timestamp
        - data
      properties:
        status:
          type: string
          enum: [success]
        timestamp:
          type: string
          format: date-time
        data:
          $ref: '#/components/schemas/QualityMetrics'
    
    QualityMetrics:
      type: object
      properties:
        summary:
          type: object
          properties:
            total_invoices:
              type: integer
            completed_invoices:
              type: integer
            failed_invoices:
              type: integer
            overall_accuracy:
              type: number
              format: float
            stp_rate:
              type: number
              format: float
              description: Straight-through processing rate (no manual intervention needed)
        by_format:
          type: array
          items:
            type: object
            properties:
              file_type:
                type: string
              total:
                type: integer
              critical_fields_complete_pct:
                type: number
                format: float
              avg_vendor_confidence:
                type: number
                format: float
              avg_invoice_number_confidence:
                type: number
                format: float
              avg_total_amount_confidence:
                type: number
                format: float
        missing_fields:
          type: object
          additionalProperties:
            type: integer
        low_confidence_invoices:
          type: object
          properties:
            count:
              type: integer
            percentage:
              type: number
              format: float
        validation_failures:
          type: object
          properties:
            total:
              type: integer
            by_rule:
              type: array
              items:
                type: object
                properties:
                  rule_name:
                    type: string
                  count:
                    type: integer
        date_range:
          type: object
          properties:
            from:
              type: string
              format: date
            to:
              type: string
              format: date
    
    TrendsResponse:
      type: object
      required:
        - status
        - timestamp
        - data
      properties:
        status:
          type: string
          enum: [success]
        timestamp:
          type: string
          format: date-time
        data:
          type: object
          properties:
            date_range:
              type: object
              properties:
                from:
                  type: string
                  format: date
                to:
                  type: string
                  format: date
            granularity:
              type: string
              enum: [day, week, month]
            series:
              type: array
              items:
                type: object
                properties:
                  metric:
                    type: string
                  label:
                    type: string
                  data_points:
                    type: array
                    items:
                      type: object
                      properties:
                        date:
                          type: string
                        value:
                          type: number
                          format: float
                        invoice_count:
                          type: integer
    
    BatchProcessRequest:
      type: object
      required:
        - invoice_ids
      properties:
        invoice_ids:
          type: array
          items:
            type: string
            format: uuid
          minItems: 1
          maxItems: 100
        max_concurrency:
          type: integer
          minimum: 1
          maximum: 20
          default: 10
          description: Maximum number of invoices to process concurrently
        force_reprocess:
          type: boolean
          default: false
        processing_options:
          type: object
          properties:
            format_specific:
              type: object
              additionalProperties: true
    
    BatchProcessResponse:
      type: object
      required:
        - status
        - timestamp
        - data
      properties:
        status:
          type: string
          enum: [success]
        timestamp:
          type: string
          format: date-time
        data:
          type: object
          properties:
            batch_id:
              type: string
            invoice_count:
              type: integer
            estimated_completion_seconds:
              type: integer
            status:
              type: string
              enum: [queued, processing, completed, failed]
            progress_url:
              type: string
    
    BatchProgressResponse:
      type: object
      required:
        - status
        - timestamp
        - data
      properties:
        status:
          type: string
          enum: [success]
        timestamp:
          type: string
          format: date-time
        data:
          type: object
          properties:
            batch_id:
              type: string
            status:
              type: string
              enum: [queued, processing, completed, failed]
            total_invoices:
              type: integer
            completed:
              type: integer
            failed:
              type: integer
            in_progress:
              type: integer
            progress_percentage:
              type: integer
              minimum: 0
              maximum: 100
            started_at:
              type: string
              format: date-time
            estimated_completion_at:
              type: string
              format: date-time
              nullable: true
    
    ErrorResponse:
      type: object
      required:
        - status
        - timestamp
        - error
      properties:
        status:
          type: string
          enum: [error]
        timestamp:
          type: string
          format: date-time
        error:
          type: object
          required:
            - code
            - message
          properties:
            code:
              type: string
            message:
              type: string
            details:
              type: object
              additionalProperties: true

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

security:
  - BearerAuth: []

