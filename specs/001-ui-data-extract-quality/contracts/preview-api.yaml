openapi: 3.0.3
info:
  title: Invoice File Preview API
  description: API endpoints for previewing invoice files (PDF, CSV, Excel, images) in the dashboard
  version: 1.0.0
  contact:
    name: AI E-Invoicing Team

servers:
  - url: http://localhost:${API_PORT:-8000}/api/v1
    description: Local development server
  - url: https://api.einvoicing.example.com/api/v1
    description: Production server

tags:
  - name: preview
    description: File preview operations

paths:
  /invoices/{invoice_id}/preview:
    get:
      summary: Get file preview data for an invoice
      description: |
        Returns file preview data in a format suitable for rendering in the dashboard.
        - For PDFs: Returns base64-encoded PDF or page images
        - For CSV/Excel: Returns parsed tabular data
        - For images: Returns optimized image data
        
        Response format adapts based on file type and size constraints.
      operationId: getInvoicePreview
      tags:
        - preview
      parameters:
        - name: invoice_id
          in: path
          required: true
          description: UUID of the invoice to preview
          schema:
            type: string
            format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        
        - name: preview_type
          in: query
          required: false
          description: Type of preview to generate (defaults to 'auto' based on file type)
          schema:
            type: string
            enum: [auto, thumbnail, full, data_only]
            default: auto
          examples:
            auto:
              value: auto
              summary: Automatically choose best preview type based on file
            thumbnail:
              value: thumbnail
              summary: Small preview (images/PDF first page only)
            full:
              value: full
              summary: Full file preview (may be large)
            data_only:
              value: data_only
              summary: Structured data only, no visual preview (for CSV/Excel)
        
        - name: page
          in: query
          required: false
          description: Page number for multi-page PDFs (1-indexed)
          schema:
            type: integer
            minimum: 1
            default: 1
        
        - name: max_rows
          in: query
          required: false
          description: Maximum rows to return for CSV/Excel preview
          schema:
            type: integer
            minimum: 10
            maximum: 1000
            default: 100
      
      responses:
        '200':
          description: File preview data successfully retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PreviewResponse'
              examples:
                pdfPreview:
                  summary: PDF file preview
                  value:
                    status: success
                    timestamp: "2026-01-07T10:30:00Z"
                    data:
                      invoice_id: "550e8400-e29b-41d4-a716-446655440000"
                      file_name: "invoice_2024_001.pdf"
                      file_type: "pdf"
                      file_size_bytes: 245680
                      preview_type: "full"
                      preview_metadata:
                        page_count: 3
                        current_page: 1
                        has_text_layer: true
                      preview_data:
                        format: "base64_pdf"
                        content: "JVBERi0xLjQKJeLjz9MKMy..."
                        mime_type: "application/pdf"
                      cached: true
                      generated_at: "2026-01-07T10:25:00Z"
                
                csvPreview:
                  summary: CSV file preview
                  value:
                    status: success
                    timestamp: "2026-01-07T10:30:00Z"
                    data:
                      invoice_id: "550e8400-e29b-41d4-a716-446655440000"
                      file_name: "invoices_batch.csv"
                      file_type: "csv"
                      file_size_bytes: 52400
                      preview_type: "data_only"
                      preview_metadata:
                        row_count: 1523
                        column_count: 8
                        has_headers: true
                        delimiter: ","
                        encoding: "utf-8"
                      preview_data:
                        format: "tabular"
                        columns: ["Vendor", "Invoice #", "Date", "Amount", "Tax", "Total", "Status", "Notes"]
                        rows:
                          - ["ACME Corp", "INV-2024-001", "2024-01-15", "1000.00", "100.00", "1100.00", "Paid", ""]
                          - ["Tech Solutions", "TS-5678", "2024-01-20", "2500.00", "250.00", "2750.00", "Pending", "Follow up"]
                        total_rows: 1523
                        displayed_rows: 100
                      cached: false
                      generated_at: "2026-01-07T10:30:00Z"
                
                imagePreview:
                  summary: Image file preview
                  value:
                    status: success
                    timestamp: "2026-01-07T10:30:00Z"
                    data:
                      invoice_id: "550e8400-e29b-41d4-a716-446655440000"
                      file_name: "scanned_invoice.jpg"
                      file_type: "jpg"
                      file_size_bytes: 1458620
                      preview_type: "full"
                      preview_metadata:
                        width: 2480
                        height: 3508
                        format: "JPEG"
                        dpi: 300
                      preview_data:
                        format: "base64_image"
                        content: "/9j/4AAQSkZJRgABAQEAAAAAAAD/2wBD..."
                        mime_type: "image/jpeg"
                      cached: true
                      generated_at: "2026-01-07T09:45:00Z"
        
        '400':
          description: Invalid request parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status: error
                timestamp: "2026-01-07T10:30:00Z"
                error:
                  code: "INVALID_PARAMETER"
                  message: "Invalid page number. Page must be between 1 and 3."
                  details:
                    parameter: "page"
                    provided_value: 5
                    max_pages: 3
        
        '404':
          description: Invoice not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status: error
                timestamp: "2026-01-07T10:30:00Z"
                error:
                  code: "INVOICE_NOT_FOUND"
                  message: "Invoice with ID 550e8400-e29b-41d4-a716-446655440000 not found"
        
        '413':
          description: File too large for preview
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status: error
                timestamp: "2026-01-07T10:30:00Z"
                error:
                  code: "FILE_TOO_LARGE"
                  message: "File size exceeds preview limit of 10 MB"
                  details:
                    file_size_bytes: 15728640
                    max_size_bytes: 10485760
        
        '500':
          description: Server error during preview generation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status: error
                timestamp: "2026-01-07T10:30:00Z"
                error:
                  code: "PREVIEW_GENERATION_FAILED"
                  message: "Failed to generate preview for file"
                  details:
                    error_type: "PDFProcessingError"

  /invoices/{invoice_id}/preview/thumbnail:
    get:
      summary: Get thumbnail preview of invoice file
      description: Returns a small thumbnail image suitable for list views (optimized for fast loading)
      operationId: getInvoiceThumbnail
      tags:
        - preview
      parameters:
        - name: invoice_id
          in: path
          required: true
          description: UUID of the invoice
          schema:
            type: string
            format: uuid
        
        - name: size
          in: query
          required: false
          description: Thumbnail size in pixels (width, height will maintain aspect ratio)
          schema:
            type: integer
            enum: [64, 128, 256]
            default: 128
      
      responses:
        '200':
          description: Thumbnail image
          content:
            image/jpeg:
              schema:
                type: string
                format: binary
            image/png:
              schema:
                type: string
                format: binary
        
        '404':
          description: Invoice not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    PreviewResponse:
      type: object
      required:
        - status
        - timestamp
        - data
      properties:
        status:
          type: string
          enum: [success]
          description: Response status
        timestamp:
          type: string
          format: date-time
          description: Response timestamp (ISO 8601)
        data:
          $ref: '#/components/schemas/PreviewData'
    
    PreviewData:
      type: object
      required:
        - invoice_id
        - file_name
        - file_type
        - file_size_bytes
        - preview_type
        - preview_data
        - cached
        - generated_at
      properties:
        invoice_id:
          type: string
          format: uuid
          description: Invoice UUID
        file_name:
          type: string
          description: Original file name
        file_type:
          type: string
          enum: [pdf, csv, xlsx, jpg, png, webp, avif]
          description: File type
        file_size_bytes:
          type: integer
          description: File size in bytes
        preview_type:
          type: string
          enum: [thumbnail, full, data_only]
          description: Type of preview generated
        preview_metadata:
          type: object
          description: Format-specific metadata about the file
          additionalProperties: true
        preview_data:
          oneOf:
            - $ref: '#/components/schemas/Base64PreviewData'
            - $ref: '#/components/schemas/TabularPreviewData'
        cached:
          type: boolean
          description: Whether preview was served from cache
        generated_at:
          type: string
          format: date-time
          description: When preview was generated
    
    Base64PreviewData:
      type: object
      required:
        - format
        - content
        - mime_type
      properties:
        format:
          type: string
          enum: [base64_pdf, base64_image]
          description: Format of the preview content
        content:
          type: string
          format: byte
          description: Base64-encoded file content
        mime_type:
          type: string
          description: MIME type of the content
          example: "application/pdf"
    
    TabularPreviewData:
      type: object
      required:
        - format
        - columns
        - rows
        - total_rows
        - displayed_rows
      properties:
        format:
          type: string
          enum: [tabular]
          description: Format of the preview content
        columns:
          type: array
          items:
            type: string
          description: Column names
        rows:
          type: array
          items:
            type: array
            items:
              type: string
          description: Data rows (each row is an array of values)
        total_rows:
          type: integer
          description: Total number of rows in the file
        displayed_rows:
          type: integer
          description: Number of rows included in preview
    
    ErrorResponse:
      type: object
      required:
        - status
        - timestamp
        - error
      properties:
        status:
          type: string
          enum: [error]
        timestamp:
          type: string
          format: date-time
        error:
          type: object
          required:
            - code
            - message
          properties:
            code:
              type: string
              description: Error code for programmatic handling
            message:
              type: string
              description: Human-readable error message
            details:
              type: object
              description: Additional error details
              additionalProperties: true

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

security:
  - BearerAuth: []

